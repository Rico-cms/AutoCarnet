<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCarnet - Multi-Véhicules</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-break-inside-avoid { page-break-inside: avoid; }
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; opacity: 0; }
        .slide-up { animation: slideUp 0.3s ease-out forwards; opacity: 0; transform: translateY(20px); }
        
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        .timeline-line::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 1.25rem;
            width: 2px;
            background: linear-gradient(to bottom, transparent, #e2e8f0, transparent);
        }
        @media (min-width: 768px) {
            .timeline-line::before {
                left: 50%;
                transform: translateX(-1px);
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-28 md:pb-10 selection:bg-blue-100 selection:text-blue-900">

    <!-- HEADER -->
    <header class="bg-slate-900 text-white pt-6 pb-24 px-6 sticky top-0 z-10 shadow-lg no-print transition-all duration-300">
        <div class="max-w-4xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 w-full sm:w-auto">
                <i data-lucide="shield-check" class="text-green-400 w-8 h-8"></i>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight">AutoCarnet</h1>
                    <p class="text-slate-400 text-xs font-medium">Gestion de Flotte & Historique</p>
                </div>
            </div>

            <!-- Vehicle Selector -->
            <div id="vehicle-selector-container" class="hidden w-full sm:w-auto flex items-center gap-2 bg-slate-800 p-1 rounded-xl border border-slate-700">
                <select id="vehicle-select" class="bg-transparent text-white text-sm font-bold p-2 outline-none cursor-pointer w-full sm:w-48">
                    <!-- Options injected via JS -->
                </select>
                <button id="btn-add-car-header" class="p-2 bg-blue-600 hover:bg-blue-500 rounded-lg transition" title="Ajouter un véhicule">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
                <button id="btn-edit-car-header" class="p-2 hover:bg-slate-700 rounded-lg transition" title="Modifier ce véhicule">
                    <i data-lucide="settings" class="w-4 h-4 text-slate-300"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-4xl mx-auto px-4 -mt-16 relative z-20 space-y-6">
        
        <!-- LOADING -->
        <div id="loading-state" class="text-center py-20 text-slate-500 flex flex-col items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-500 mb-4"></div>
            Chargement...
        </div>

        <!-- ONBOARDING (Zero Vehicles) -->
        <div id="onboarding-state" class="hidden flex flex-col items-center justify-center min-h-[50vh] text-center fade-in pt-10">
            <div class="bg-gradient-to-tr from-blue-600 to-indigo-600 p-6 rounded-3xl mb-6 shadow-xl shadow-blue-200 ring-4 ring-white">
                <i data-lucide="car-front" class="w-16 h-16 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Bienvenue</h1>
            <p class="text-slate-500 mb-8 max-w-sm">Ajoutez votre premier véhicule pour commencer le suivi.</p>
            <button id="btn-start-onboarding" class="bg-slate-900 text-white px-8 py-4 rounded-2xl font-bold hover:bg-slate-800 transition shadow-xl hover:-translate-y-1 flex items-center gap-3">
                <i data-lucide="plus-circle" class="w-5 h-5"></i> Ajouter un véhicule
            </button>
        </div>

        <!-- APP CONTENT -->
        <div id="app-content" class="hidden space-y-6 fade-in">
            
            <div id="alerts-container" class="space-y-2 no-print"></div>

            <!-- DASHBOARD CARD -->
            <div class="bg-white rounded-xl shadow-xl shadow-slate-200 overflow-hidden print:shadow-none print:border print:border-slate-300">
                <div class="p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white">
                    <div>
                        <div class="flex items-center gap-3 mb-1.5">
                            <h2 id="car-title" class="text-2xl font-black text-slate-800 tracking-tight">--</h2>
                            <span id="car-year" class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded font-mono border border-slate-200">--</span>
                        </div>
                        <div class="flex flex-wrap gap-4 text-sm font-medium text-slate-500">
                            <span class="flex items-center gap-1.5">
                                <i data-lucide="trending-up" class="w-4 h-4 text-slate-400"></i>
                                <span id="car-mileage">-- km</span>
                            </span>
                            <span class="flex items-center gap-1.5 font-mono bg-slate-50 px-2 py-0.5 rounded text-slate-600">
                                <i data-lucide="file-text" class="w-3.5 h-3.5 text-slate-400"></i>
                                <span id="car-plate">--</span>
                            </span>
                            <span class="flex items-center gap-1.5 text-blue-600">
                                <i data-lucide="user" class="w-3.5 h-3.5"></i>
                                <span id="car-owner">--</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="text-right hidden sm:block">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Confiance</div>
                            <div id="trust-score-text" class="font-black text-lg text-slate-400">0%</div>
                        </div>
                        <div class="relative w-12 h-12 flex items-center justify-center">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="24" cy="24" r="20" stroke="currentColor" stroke-width="4" fill="transparent" class="text-slate-100" />
                                <circle id="trust-score-circle" cx="24" cy="24" r="20" stroke="currentColor" stroke-width="4" fill="transparent" stroke-dasharray="125" stroke-dashoffset="125" class="text-blue-500 transition-all duration-1000 ease-out" />
                            </svg>
                            <i id="trust-score-icon" data-lucide="award" class="w-5 h-5 absolute text-slate-300"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 divide-x divide-slate-100 border-t border-slate-100 bg-slate-50/50">
                    <div class="p-4 text-center">
                        <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Investi</div>
                        <div id="stat-invest" class="font-bold text-slate-700">0 FCFA</div>
                    </div>
                    <div class="p-4 text-center">
                        <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Entrées</div>
                        <div id="stat-logs" class="font-bold text-slate-700">0</div>
                    </div>
                    <div class="p-4 text-center">
                        <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Prochain Entretien</div>
                        <div id="stat-next-service" class="font-bold text-slate-700">-</div>
                    </div>
                </div>
            </div>

            <!-- TABS -->
            <div id="view-dashboard" class="space-y-5 no-print">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 px-1">
                    <h3 class="text-lg font-bold text-slate-800">Historique</h3>
                    <div class="flex gap-2 overflow-x-auto w-full sm:w-auto pb-2 sm:pb-0 no-scrollbar">
                        <button data-filter="all" class="filter-btn active px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition bg-slate-800 text-white shadow-md">Tout</button>
                        <button data-filter="maintenance" class="filter-btn px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition bg-white text-slate-600 border border-slate-200">Entretien</button>
                        <button data-filter="admin" class="filter-btn px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition bg-white text-slate-600 border border-slate-200">Papiers</button>
                    </div>
                </div>

                <button id="btn-add-log-mobile" class="w-full sm:hidden py-3 bg-blue-50 text-blue-600 rounded-xl font-bold border border-blue-100 flex items-center justify-center gap-2 shadow-sm">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Ajouter une intervention
                </button>

                <div id="timeline-container" class="space-y-6 relative timeline-line pb-10"></div>
            </div>

            <!-- VIEW: CERTIFICATE -->
            <div id="view-buyer" class="hidden space-y-6 slide-up">
                <div class="bg-gradient-to-br from-slate-900 to-slate-800 text-white p-8 rounded-3xl shadow-2xl text-center print:border print:border-slate-800 print:text-black print:bg-none">
                    <div class="bg-white/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-5 backdrop-blur-sm print:hidden">
                        <i data-lucide="shield-check" class="w-10 h-10 text-green-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Certificat de Transparence</h2>
                    <p class="text-slate-400 max-w-md mx-auto text-sm mb-6 print:text-slate-600">
                        Historique certifié par le propriétaire.
                    </p>
                    
                    <div class="grid grid-cols-2 gap-4 text-left print:grid-cols-2">
                        <div class="bg-white/5 p-4 rounded-xl print:border print:border-slate-300">
                            <div class="text-[10px] text-slate-400 uppercase font-bold mb-1">Propriétaire</div>
                            <div id="cert-owner" class="font-bold text-lg">--</div>
                        </div>
                        <div class="bg-white/5 p-4 rounded-xl print:border print:border-slate-300">
                            <div class="text-[10px] text-slate-400 uppercase font-bold mb-1">Véhicule</div>
                            <div id="cert-car" class="font-bold text-lg">--</div>
                            <div id="cert-vin" class="text-xs font-mono text-slate-400 mt-1">VIN: --</div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center px-2 no-print">
                    <h3 class="text-lg font-bold text-slate-800">Opérations</h3>
                    <button onclick="window.print()" class="flex items-center gap-2 text-sm font-bold text-slate-600 bg-slate-100 px-4 py-2 rounded-lg">
                        <i data-lucide="printer" class="w-4 h-4"></i> Imprimer
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden print:border-0">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 border-b border-slate-100">
                            <tr>
                                <th class="px-5 py-4 font-bold uppercase text-[10px]">Date</th>
                                <th class="px-5 py-4 font-bold uppercase text-[10px]">Opération</th>
                                <th class="px-5 py-4 font-bold uppercase text-[10px] text-right">Km</th>
                                <th class="px-5 py-4 font-bold uppercase text-[10px] text-center">Preuve</th>
                            </tr>
                        </thead>
                        <tbody id="cert-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- NAV BOTTOM -->
    <nav id="bottom-nav" class="hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 px-6 py-2 pb-6 md:pb-2 z-40 flex justify-around items-center md:max-w-md md:mx-auto md:bottom-6 md:rounded-full md:shadow-2xl md:border no-print">
        <button id="nav-dashboard" class="flex flex-col items-center gap-1 p-2 rounded-xl text-blue-600 bg-blue-50 w-16 transition">
            <i data-lucide="history" class="w-6 h-6"></i> <span class="text-[10px] font-bold">Journal</span>
        </button>
        <button id="nav-add" class="flex flex-col items-center justify-center -mt-10 bg-slate-900 text-white w-14 h-14 rounded-2xl shadow-lg shadow-slate-300 hover:scale-105 transition hover:bg-slate-800 ring-4 ring-white">
            <i data-lucide="plus-circle" class="w-7 h-7"></i>
        </button>
        <button id="nav-buyer" class="flex flex-col items-center gap-1 p-2 rounded-xl text-slate-400 w-16 transition hover:text-slate-600">
            <i data-lucide="share-2" class="w-6 h-6"></i> <span class="text-[10px] font-bold">Vente</span>
        </button>
    </nav>

    <!-- MODAL: ADD/EDIT LOG -->
    <div id="modal-add-log" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 no-print modal-backdrop">
        <div class="bg-white w-full max-w-lg sm:rounded-2xl rounded-t-2xl p-6 shadow-2xl animate-in slide-in-from-bottom-10 sm:zoom-in-95 duration-200 flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4">
                <h2 id="modal-log-title" class="text-xl font-bold text-slate-800 flex items-center gap-2"></h2>
                <button class="btn-close-modal p-2 hover:bg-slate-100 rounded-full text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-add-log" class="space-y-4 overflow-y-auto px-1 pb-2">
                <input type="hidden" id="log-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                        <select id="log-type" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                            <option value="maintenance">Entretien</option>
                            <option value="repair">Réparation</option>
                            <option value="admin">Papiers</option>
                            <option value="upgrade">Amélioration</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                        <input type="date" id="log-date" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                    </div>
                </div>
                
                <div id="expiry-field" class="hidden bg-purple-50 p-4 rounded-xl border border-purple-100">
                     <label class="block text-xs font-bold text-purple-700 uppercase mb-1 flex items-center gap-2"><i data-lucide="calendar" class="w-3 h-3"></i> Expiration (Assurance/Visite)</label>
                     <input type="date" id="log-expiry" class="w-full p-3 bg-white border border-purple-200 rounded-xl">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Titre de l'opération</label>
                    <input type="text" id="log-title" required list="service-suggestions" placeholder="Ex: Vidange, Pneus..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-medium">
                    <datalist id="service-suggestions">
                        <option value="Vidange Moteur"></option><option value="Visite Technique"></option><option value="Assurance"></option><option value="Pneus"></option>
                    </datalist>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Km</label>
                        <input type="number" id="log-mileage" placeholder="ex: 120000" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Coût (FCFA)</label>
                        <input type="number" id="log-cost" placeholder="0" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-medium">
                    </div>
                </div>

                <!-- Proof Logic -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4">
                    <div class="flex items-center gap-2 border-b border-slate-200 pb-2">
                        <input type="checkbox" id="log-certified" class="w-4 h-4 text-blue-600 rounded cursor-pointer">
                        <label for="log-certified" class="text-xs font-bold text-slate-700 cursor-pointer select-none flex-1">
                            Travail effectué par un PRO ?
                        </label>
                    </div>

                    <div id="pro-details" class="hidden space-y-3 animate-in fade-in">
                        <div class="bg-yellow-50 text-yellow-800 text-xs p-2 rounded border border-yellow-100 flex gap-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4 shrink-0"></i>
                            Pour valider le "Pro", le nom et le téléphone du garage sont requis.
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="log-provider" placeholder="Nom du Garage *" class="w-full p-2 bg-white border border-slate-200 rounded-lg text-sm">
                            <input type="tel" id="log-provider-phone" placeholder="Tél du Garage *" class="w-full p-2 bg-white border border-slate-200 rounded-lg text-sm">
                        </div>
                    </div>

                    <div class="relative group border border-slate-200 border-dashed rounded-lg p-3 hover:bg-white transition cursor-pointer">
                        <input type="file" id="log-file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                        <div class="flex items-center gap-3 relative z-10 pointer-events-none">
                            <div id="file-icon" class="w-8 h-8 rounded-full bg-white shadow-sm text-slate-400 flex items-center justify-center"><i data-lucide="camera" class="w-4 h-4"></i></div>
                            <div>
                                <div class="text-[10px] font-bold text-slate-500 uppercase">Preuve (Facture/Reçu)</div>
                                <div id="file-name" class="text-xs text-slate-800 font-medium">Aucun fichier</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition flex justify-center items-center gap-2">
                    <i data-lucide="check" class="w-5 h-5"></i> <span id="btn-save-text">Valider</span>
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL: VEHICLE PROFILE (ADD/EDIT) -->
    <div id="modal-profile" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 no-print modal-backdrop">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl animate-in zoom-in-95 duration-200" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-5">
                <h2 id="modal-profile-title" class="text-xl font-bold text-slate-800">Ajouter un véhicule</h2>
                <button class="btn-close-modal text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-profile" class="space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="prof-id">
                
                <!-- Section Propriétaire -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                    <div class="flex items-center gap-2 text-blue-800 text-xs font-bold uppercase tracking-wider">
                        <i data-lucide="user-check" class="w-4 h-4"></i> Propriétaire (Identité)
                    </div>
                    <input id="prof-owner" required placeholder="Nom & Prénom" class="border border-blue-200 p-2.5 rounded-lg w-full text-sm bg-white">
                    <input id="prof-contact" placeholder="Téléphone (pour le certificat)" class="border border-blue-200 p-2.5 rounded-lg w-full text-sm bg-white">
                </div>

                <!-- Section Véhicule -->
                <div class="space-y-3">
                    <div class="text-slate-400 text-xs font-bold uppercase tracking-wider ml-1">Détails Véhicule</div>
                    <div class="grid grid-cols-2 gap-3">
                        <input id="prof-make" required placeholder="Marque (ex: Toyota)" class="border border-slate-200 p-3 rounded-xl w-full">
                        <input id="prof-model" required placeholder="Modèle" class="border border-slate-200 p-3 rounded-xl w-full">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input id="prof-year" type="number" required placeholder="Année" class="border border-slate-200 p-3 rounded-xl w-full">
                        <input id="prof-mileage" type="number" required placeholder="Km actuel" class="border border-slate-200 p-3 rounded-xl w-full">
                    </div>
                    <input id="prof-plate" required placeholder="Immatriculation (AA-123-BB)" class="border border-slate-200 p-3 rounded-xl w-full uppercase">
                    <input id="prof-vin" placeholder="N° VIN / Châssis (Recommandé)" class="border border-slate-200 p-3 rounded-xl w-full uppercase">
                </div>

                <button type="submit" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg mt-4">
                    <i data-lucide="save" class="w-5 h-5"></i> Enregistrer
                </button>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // INIT
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'autocarnet-v2';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let currentUser = null;
        let currentVehicleId = null;
        let vehicleList = [];
        let currentLogs = [];
        let filterType = 'all';
        let unsubLogs = null;

        // DOM UTILS
        const el = (id) => document.getElementById(id);
        const formatMoney = (amount) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(amount).replace('XOF', 'FCFA');

        // --- AUTH & LOAD ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) loadVehicles(user.uid);
        });

        initAuth();

        // --- VEHICLE MANAGEMENT ---
        function loadVehicles(uid) {
            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'vehicles'), (snapshot) => {
                vehicleList = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                el('loading-state').classList.add('hidden');

                if (vehicleList.length === 0) {
                    showOnboarding();
                } else {
                    if (!currentVehicleId || !vehicleList.find(v => v.id === currentVehicleId)) {
                        switchVehicle(vehicleList[0].id);
                    } else {
                        renderHeaderSelector();
                        renderDashboard();
                    }
                    el('onboarding-state').classList.add('hidden');
                    el('app-content').classList.remove('hidden');
                    el('bottom-nav').classList.remove('hidden');
                    el('vehicle-selector-container').classList.remove('hidden');
                }
            });
        }

        function switchVehicle(vehId) {
            currentVehicleId = vehId;
            renderHeaderSelector();
            renderDashboard();
            
            if (unsubLogs) unsubLogs();
            const logsRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'vehicles', vehId, 'logs');
            unsubLogs = onSnapshot(logsRef, (snapshot) => {
                currentLogs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                currentLogs.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderLogs();
                updateStats();
                checkAlerts();
            });
        }

        // --- RENDERING ---
        function renderHeaderSelector() {
            const select = el('vehicle-select');
            select.innerHTML = '';
            vehicleList.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.text = `${v.make} ${v.model}`;
                if(v.id === currentVehicleId) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function renderDashboard() {
            const car = vehicleList.find(v => v.id === currentVehicleId);
            if (!car) return;

            el('car-title').textContent = `${car.make} ${car.model}`;
            el('car-year').textContent = car.year;
            el('car-mileage').textContent = `${parseInt(car.mileage).toLocaleString()} km`;
            el('car-plate').textContent = car.plate;
            el('car-owner').textContent = car.owner || 'Propriétaire inconnu';
            
            el('cert-car').textContent = `${car.make} ${car.model}`;
            el('cert-vin').textContent = `VIN: ${car.vin || 'Non renseigné'}`;
            el('cert-owner').textContent = car.owner || '--';
        }

        function renderLogs() {
            const container = el('timeline-container');
            const tbody = el('cert-table-body');
            container.innerHTML = '';
            tbody.innerHTML = '';

            const filtered = filterType === 'all' ? currentLogs : currentLogs.filter(l => l.type === filterType);

            if(filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-10 bg-white rounded-xl border border-dashed border-slate-300 text-slate-400">Aucun historique pour ce filtre.</div>`;
                return;
            }

            filtered.forEach(log => {
                let trustIcon = '';
                let trustBadge = '';
                
                if (log.isCertified) {
                    if (log.hasProof && log.provider && log.providerPhone) {
                        trustIcon = '<i data-lucide="shield-check" class="w-4 h-4 text-green-500 fill-green-50"></i>';
                        trustBadge = `<span class="text-[10px] bg-green-100 text-green-700 px-1 rounded font-bold border border-green-200">Vérifié</span>`;
                    } else {
                        trustIcon = '<i data-lucide="alert-circle" class="w-4 h-4 text-orange-400"></i>';
                    }
                }

                const card = document.createElement('div');
                card.className = "relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group slide-up";
                const colors = { maintenance: 'text-blue-600', repair: 'text-orange-600', admin: 'text-purple-600' };
                const iconColor = colors[log.type] || 'text-slate-600';

                // Display file name if available
                const fileDisplay = log.proofFileName ? 
                    `<div class="flex items-center gap-2 text-green-600 text-xs font-bold truncate"><i data-lucide="paperclip" class="w-3 h-3"></i> ${log.proofFileName}</div>` :
                    (log.hasProof ? `<div class="flex items-center gap-2 text-green-600 text-xs font-bold"><i data-lucide="paperclip" class="w-3 h-3"></i> Preuve jointe</div>` : '');

                card.innerHTML = `
                    <div class="flex items-center justify-center w-10 h-10 rounded-full border-4 border-slate-50 bg-white shadow-md shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10 absolute left-0 md:static transition group-hover:scale-110">
                        <i data-lucide="circle-dot" class="w-4 h-4 ${iconColor}"></i>
                    </div>
                    <div class="w-[calc(100%-3.5rem)] md:w-[calc(50%-2.5rem)] ml-14 md:ml-0 bg-white rounded-xl p-5 shadow-sm border border-slate-100 hover:shadow-lg transition relative">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] uppercase font-bold text-slate-500 bg-slate-100 px-2 rounded">${log.type}</span>
                            <span class="text-xs font-bold text-slate-400">${new Date(log.date).toLocaleDateString('fr-FR')}</span>
                        </div>
                        <h4 class="font-bold text-slate-800 text-base flex items-center gap-2 mb-1">
                            ${log.title} ${trustIcon}
                        </h4>
                        <div class="text-sm text-slate-600 space-y-1 mb-3">
                            <div class="flex items-center gap-2"><i data-lucide="gauge" class="w-3 h-3 text-slate-400"></i> ${parseInt(log.mileage).toLocaleString()} km</div>
                            ${log.provider ? `<div class="flex items-center gap-2"><i data-lucide="store" class="w-3 h-3 text-slate-400"></i> ${log.provider} ${trustBadge}</div>` : ''}
                            ${fileDisplay}
                        </div>
                         <div class="absolute bottom-4 right-4 flex gap-3 opacity-0 group-hover:opacity-100 transition">
                             <button onclick="editLog('${log.id}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                             <button onclick="deleteLog('${log.id}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash" class="w-4 h-4"></i></button>
                        </div>
                        <div class="font-bold text-slate-700 bg-slate-50 px-2 py-1 rounded text-sm w-fit inline-block">
                            ${log.cost > 0 ? formatMoney(log.cost) : 'Gratuit'}
                        </div>
                    </div>
                `;
                container.appendChild(card);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-5 py-3 text-slate-500 font-medium whitespace-nowrap">${new Date(log.date).toLocaleDateString('fr-FR')}</td>
                    <td class="px-5 py-3">
                        <div class="font-bold text-slate-800">${log.title}</div>
                        <div class="text-xs text-slate-500">${log.provider || ''} ${log.providerPhone ? '('+log.providerPhone+')' : ''}</div>
                    </td>
                    <td class="px-5 py-3 text-right font-mono text-slate-600">${parseInt(log.mileage).toLocaleString()}</td>
                    <td class="px-5 py-3 text-center text-xs font-bold ${log.hasProof ? 'text-green-600' : 'text-slate-300'}">${log.hasProof ? 'OUI' : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- STATS & ALERTS ---
        function updateStats() {
            const car = vehicleList.find(v => v.id === currentVehicleId);
            if(!car) return;

            const total = currentLogs.reduce((acc, l) => acc + (l.cost || 0), 0);
            el('stat-invest').textContent = formatMoney(total);
            el('stat-logs').textContent = currentLogs.length;

            const lastOil = currentLogs.find(l => l.title.toLowerCase().includes('vidange'));
            if(lastOil) {
                const next = parseInt(lastOil.mileage) + 10000;
                el('stat-next-service').textContent = `~${next.toLocaleString()} km`;
                el('stat-next-service').classList.toggle('text-red-500', next < parseInt(car.mileage));
            }

            let score = 0;
            if(car.vin && car.vin.length > 5) score += 20;
            if(car.owner && car.owner.length > 3) score += 10;
            score += Math.min(currentLogs.length * 3, 30);
            const verifiedLogs = currentLogs.filter(l => l.isCertified && l.hasProof && l.provider && l.providerPhone);
            score += Math.min(verifiedLogs.length * 5, 40);

            el('trust-score-text').textContent = score + "%";
            const offset = 125 - (125 * score) / 100;
            el('trust-score-circle').style.strokeDashoffset = offset;
            
            if(score > 70) el('trust-score-circle').classList.add('text-green-500');
            else if(score < 40) el('trust-score-circle').classList.add('text-red-500');
        }

        function checkAlerts() {
            const container = el('alerts-container');
            container.innerHTML = '';
            const now = new Date();
            currentLogs.forEach(log => {
                if(log.type === 'admin' && log.expiryDate) {
                    const days = (new Date(log.expiryDate) - now) / (86400000);
                    if(days < 30) {
                        const div = document.createElement('div');
                        const urgent = days < 0;
                        div.className = `p-3 rounded-lg flex items-center gap-3 text-sm font-bold ${urgent ? 'bg-red-50 text-red-800' : 'bg-orange-50 text-orange-800'}`;
                        div.innerHTML = `<i data-lucide="alert-circle" class="w-5 h-5"></i> ${log.title} ${urgent ? 'EXPIRÉ' : 'expire bientôt'}`;
                        container.appendChild(div);
                    }
                }
            });
            lucide.createIcons();
        }

        // --- INTERACTIONS ---
        el('vehicle-select').addEventListener('change', (e) => switchVehicle(e.target.value));

        window.toggleModal = (id, show) => {
            const m = el(id);
            if(show) m.classList.remove('hidden'); else m.classList.add('hidden');
        };

        document.querySelectorAll('.modal-backdrop').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if(e.target === modal) modal.classList.add('hidden');
            });
        });
        document.addEventListener('keydown', (e) => {
            if(e.key === "Escape") document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.add('hidden'));
        });
        document.querySelectorAll('.btn-close-modal').forEach(b => b.addEventListener('click', (e) => {
             e.target.closest('.modal-backdrop').classList.add('hidden');
        }));

        el('btn-add-car-header').addEventListener('click', () => openProfileModal());
        el('btn-edit-car-header').addEventListener('click', () => openProfileModal(vehicleList.find(v => v.id === currentVehicleId)));
        el('btn-start-onboarding').addEventListener('click', () => openProfileModal());

        function openProfileModal(car = null) {
            el('form-profile').reset();
            if(car) {
                el('modal-profile-title').textContent = "Modifier le véhicule";
                el('prof-id').value = car.id;
                el('prof-make').value = car.make;
                el('prof-model').value = car.model;
                el('prof-year').value = car.year;
                el('prof-mileage').value = car.mileage;
                el('prof-plate').value = car.plate;
                el('prof-vin').value = car.vin || '';
                el('prof-owner').value = car.owner || '';
                el('prof-contact').value = car.ownerContact || '';
            } else {
                el('modal-profile-title').textContent = "Nouveau Véhicule";
                el('prof-id').value = '';
            }
            toggleModal('modal-profile', true);
        }

        el('form-profile').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = el('prof-id').value;
            const data = {
                make: el('prof-make').value,
                model: el('prof-model').value,
                year: el('prof-year').value,
                mileage: el('prof-mileage').value,
                plate: el('prof-plate').value,
                vin: el('prof-vin').value,
                owner: el('prof-owner').value,
                ownerContact: el('prof-contact').value,
                updatedAt: serverTimestamp()
            };

            if(id) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'vehicles', id), data);
            } else {
                data.createdAt = serverTimestamp();
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'vehicles'), data);
            }
            toggleModal('modal-profile', false);
        });

        el('nav-add').addEventListener('click', () => openLogModal());
        el('btn-add-log-mobile').addEventListener('click', () => openLogModal());

        window.editLog = (id) => {
            const log = currentLogs.find(l => l.id === id);
            if(log) openLogModal(log);
        };

        window.deleteLog = (id) => {
            if(confirm("Supprimer ?")) deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'vehicles', currentVehicleId, 'logs', id));
        };

        function openLogModal(log = null) {
            const form = el('form-add-log');
            form.reset();
            el('log-id').value = '';
            el('file-name').textContent = "Aucun fichier";
            el('file-icon').className = "w-8 h-8 rounded-full bg-white shadow-sm text-slate-400 flex items-center justify-center";
            
            if(log) {
                el('modal-log-title').innerHTML = `<i data-lucide="edit" class="w-6 h-6 text-blue-600"></i> Modifier`;
                el('log-id').value = log.id;
                el('log-type').value = log.type;
                el('log-date').value = log.date;
                el('log-title').value = log.title;
                el('log-mileage').value = log.mileage;
                el('log-cost').value = log.cost;
                el('log-certified').checked = log.isCertified;
                el('log-provider').value = log.provider || '';
                el('log-provider-phone').value = log.providerPhone || '';
                el('log-expiry').value = log.expiryDate || '';
                
                if(log.isCertified) el('pro-details').classList.remove('hidden');
                else el('pro-details').classList.add('hidden');

                if(log.hasProof) {
                    el('file-name').textContent = log.proofFileName ? `Fichier actuel: ${log.proofFileName}` : "Preuve existante";
                    el('file-icon').className = "w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center";
                }
            } else {
                el('modal-log-title').innerHTML = `<i data-lucide="plus-circle" class="w-6 h-6 text-blue-600"></i> Nouvelle Entrée`;
                el('log-date').value = new Date().toISOString().split('T')[0];
                el('pro-details').classList.add('hidden');
            }
            toggleModal('modal-add-log', true);
        }

        // FILE LISTENER FIX
        el('log-file').addEventListener('change', (e) => {
            const name = e.target.files[0]?.name || "Aucun fichier";
            el('file-name').textContent = name;
            const icon = el('file-icon');
            if(e.target.files.length > 0) {
                icon.className = "w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center";
            } else {
                icon.className = "w-8 h-8 rounded-full bg-white shadow-sm text-slate-400 flex items-center justify-center";
            }
        });

        el('log-certified').addEventListener('change', (e) => {
             if(e.target.checked) el('pro-details').classList.remove('hidden');
             else el('pro-details').classList.add('hidden');
        });

        el('log-type').addEventListener('change', (e) => {
            if(e.target.value === 'admin') el('expiry-field').classList.remove('hidden');
            else el('expiry-field').classList.add('hidden');
        });

        el('form-add-log').addEventListener('submit', async (e) => {
            e.preventDefault();
            const logId = el('log-id').value;
            const isCert = el('log-certified').checked;
            const provider = el('log-provider').value;
            const providerPhone = el('log-provider-phone').value;
            const fileInput = el('log-file');
            
            if(isCert && (!provider || !providerPhone)) {
                alert("Pour certifier une intervention 'Pro', le nom et téléphone du garage sont obligatoires.");
                return;
            }

            const currentLog = logId ? currentLogs.find(l => l.id === logId) : null;
            // Determine filename to save
            const newFileName = fileInput.files.length > 0 ? fileInput.files[0].name : null;
            const finalFileName = newFileName || (currentLog ? currentLog.proofFileName : null);

            const data = {
                type: el('log-type').value,
                date: el('log-date').value,
                title: el('log-title').value,
                mileage: parseInt(el('log-mileage').value),
                cost: parseFloat(el('log-cost').value) || 0,
                isCertified: isCert,
                provider: provider,
                providerPhone: providerPhone,
                expiryDate: el('log-type').value === 'admin' ? el('log-expiry').value : null,
                hasProof: fileInput.files.length > 0 || (currentLog && currentLog.hasProof),
                proofFileName: finalFileName // SAVE FILENAME
            };

            const ref = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'vehicles', currentVehicleId, 'logs');
            
            if(logId) {
                data.updatedAt = serverTimestamp();
                await updateDoc(doc(ref, logId), data);
            } else {
                data.createdAt = serverTimestamp();
                await addDoc(ref, data);
            }

            const car = vehicleList.find(v => v.id === currentVehicleId);
            if(car && data.mileage > parseInt(car.mileage)) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'vehicles', currentVehicleId), { mileage: data.mileage });
            }

            toggleModal('modal-add-log', false);
        });

        const switchView = (v) => {
            el('view-dashboard').classList.add('hidden');
            el('view-buyer').classList.add('hidden');
            el(v).classList.remove('hidden');
            
            el('nav-dashboard').className = "flex flex-col items-center gap-1 p-2 rounded-xl text-slate-400 w-16 transition hover:text-slate-600";
            el('nav-buyer').className = "flex flex-col items-center gap-1 p-2 rounded-xl text-slate-400 w-16 transition hover:text-slate-600";
            
            if(v === 'view-dashboard') el('nav-dashboard').className = "flex flex-col items-center gap-1 p-2 rounded-xl text-blue-600 bg-blue-50 w-16 transition";
            else el('nav-buyer').className = "flex flex-col items-center gap-1 p-2 rounded-xl text-blue-600 bg-blue-50 w-16 transition";
        };
        
        el('nav-dashboard').addEventListener('click', () => switchView('view-dashboard'));
        el('nav-buyer').addEventListener('click', () => switchView('view-buyer'));

        function showOnboarding() {
             el('onboarding-state').classList.remove('hidden');
             el('app-content').classList.add('hidden');
             el('vehicle-selector-container').classList.add('hidden');
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-slate-800', 'text-white', 'shadow-md');
                    b.classList.add('bg-white', 'text-slate-600', 'border');
                });
                e.target.classList.remove('bg-white', 'text-slate-600', 'border');
                e.target.classList.add('bg-slate-800', 'text-white', 'shadow-md');
                filterType = e.target.getAttribute('data-filter');
                renderLogs();
            });
        });

        lucide.createIcons();
    </script>
</body>
</html>
