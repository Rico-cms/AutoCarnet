<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCarnet LuxUI - Gestion Premium</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-break-inside-avoid { page-break-inside: avoid; }
        }

        /* Animations LuxUI */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        /* Timeline Design LuxUI */
        .timeline-line::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 1.25rem;
            width: 2px;
            background: linear-gradient(to bottom, #f1f5f9, #e2e8f0, #f1f5f9);
        }
        @media (min-width: 768px) {
            .timeline-line::before {
                left: 50%;
                transform: translateX(-1px);
            }
        }

        /* Modals Glassmorphism */
        .modal-container { visibility: hidden; pointer-events: none; z-index: 100; transition: all 0.3s; }
        .modal-container.active { visibility: visible; pointer-events: auto; }
        .modal-backdrop { opacity: 0; transition: opacity 0.4s ease-out; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); }
        .modal-container.active .modal-backdrop { opacity: 1; }
        .modal-content { transform: translateY(100%); opacity: 0; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-container.active .modal-content { transform: translateY(0); opacity: 1; }

        @media (min-width: 640px) {
            .modal-content { transform: scale(0.9) translateY(20px); opacity: 0; }
            .modal-container.active .modal-content { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* Custom Card Gradients */
        .card-lux {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-32 md:pb-10 selection:bg-blue-100 selection:text-blue-900 antialiased">

    <!-- HEADER LUX -->
    <header class="bg-slate-900 text-white pt-8 pb-28 px-6 sticky top-0 z-10 no-print overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
        <div class="max-w-4xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-6 relative z-10">
            <div class="flex items-center gap-4 w-full sm:w-auto">
                <div class="bg-green-400/20 p-2.5 rounded-2xl shadow-inner">
                    <i data-lucide="shield-check" class="text-green-400 w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight leading-none">AutoCarnet</h1>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1 opacity-80">Espace Premium</p>
                </div>
            </div>

            <!-- Vehicle Selector Lux -->
            <div id="vehicle-selector-container" class="hidden w-full sm:w-auto flex items-center gap-2 bg-white/10 backdrop-blur-md p-1.5 rounded-2xl border border-white/10 shadow-2xl">
                <div class="relative flex-1 sm:w-56">
                    <select id="vehicle-select" class="bg-transparent text-white text-sm font-bold py-2 pl-4 pr-10 outline-none cursor-pointer w-full appearance-none relative z-10">
                        <!-- JS inject -->
                    </select>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-white/50 absolute right-3 top-1/2 -translate-y-1/2"></i>
                </div>
                <div class="w-px h-8 bg-white/10 mx-1"></div>
                <button id="btn-add-car-header" class="p-2.5 bg-blue-600 hover:bg-blue-500 rounded-xl transition-all active:scale-90 shadow-lg shadow-blue-600/20">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
                <button id="btn-edit-car-header" class="p-2.5 hover:bg-white/10 rounded-xl transition-all active:scale-90 text-white/70">
                    <i data-lucide="settings-2" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-4xl mx-auto px-4 -mt-16 relative z-20 space-y-6">
        
        <!-- ONBOARDING LUX -->
        <div id="onboarding-state" class="hidden flex flex-col items-center justify-center min-h-[50vh] text-center fade-in pt-12">
            <div class="bg-white p-10 rounded-[3rem] shadow-2xl shadow-slate-200/50 mb-8 transform transition hover:scale-105 duration-500 border border-slate-100">
                <i data-lucide="car-front" class="w-24 h-24 text-blue-600"></i>
            </div>
            <h1 class="text-4xl font-black text-slate-900 mb-4 tracking-tight">Pr√™t √† commencer ?</h1>
            <p class="text-slate-500 mb-10 max-w-sm text-lg font-medium leading-relaxed">
                Gardez une trace pr√©cieuse de chaque intervention pour valoriser votre v√©hicule.
            </p>
            <button onclick="openProfileModal()" class="bg-slate-900 text-white px-10 py-5 rounded-[2rem] font-extrabold hover:bg-blue-600 transition-all shadow-2xl shadow-blue-500/20 hover:-translate-y-1 active:translate-y-0 flex items-center gap-4 text-xl group">
                <i data-lucide="plus-circle" class="w-7 h-7 group-hover:rotate-90 transition-transform"></i> Ajouter mon v√©hicule
            </button>
        </div>

        <!-- APP CONTENT -->
        <div id="app-content" class="hidden space-y-8 fade-in">
            
            <div id="alerts-container" class="space-y-4 no-print"></div>

            <!-- DASHBOARD CARD LUX -->
            <div class="card-lux rounded-[2.5rem] shadow-2xl shadow-slate-200/60 overflow-hidden print:border print:border-slate-300 transition-all duration-500 hover:shadow-blue-500/5 group">
                <div class="p-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-8 relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-4 mb-3">
                            <h2 id="car-title" class="text-4xl font-black text-slate-800 tracking-tight">--</h2>
                            <span id="car-year" class="bg-blue-50 text-blue-600 text-xs font-black px-3 py-1.5 rounded-xl border border-blue-100/50">--</span>
                        </div>
                        <div class="flex flex-wrap gap-4">
                            <span class="flex items-center gap-2 bg-white px-4 py-2 rounded-2xl border border-slate-100 shadow-sm text-slate-600 font-bold">
                                <i data-lucide="gauge" class="w-4 h-4 text-blue-500"></i>
                                <span id="car-mileage">-- km</span>
                            </span>
                            <span class="flex items-center gap-2 bg-white px-4 py-2 rounded-2xl border border-slate-100 shadow-sm font-mono font-bold text-slate-600">
                                <i data-lucide="hash" class="w-4 h-4 text-blue-500"></i>
                                <span id="car-plate">--</span>
                            </span>
                            <span class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-2xl shadow-lg shadow-blue-500/20 font-bold">
                                <i data-lucide="user" class="w-4 h-4"></i>
                                <span id="car-owner">--</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-5 bg-white p-5 rounded-3xl border border-slate-100 shadow-sm relative z-10">
                        <div class="text-right hidden sm:block">
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Confiance</div>
                            <div id="trust-score-text" class="font-black text-3xl text-slate-400 leading-none mt-1">0%</div>
                        </div>
                        <div class="relative w-16 h-16 flex items-center justify-center">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="6" fill="transparent" class="text-slate-100" />
                                <circle id="trust-score-circle" cx="32" cy="32" r="28" stroke="currentColor" stroke-width="6" fill="transparent" stroke-dasharray="176" stroke-dashoffset="176" stroke-linecap="round" class="text-blue-500 transition-all duration-1000 ease-out" />
                            </svg>
                            <i id="trust-score-icon" data-lucide="shield-check" class="w-8 h-8 absolute text-slate-200 transition-colors duration-500"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 divide-x divide-slate-100 border-t border-slate-100 bg-white/50 backdrop-blur-sm">
                    <div class="p-6 text-center group/stat transition-colors hover:bg-white">
                        <div class="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-2">Investi</div>
                        <div id="stat-invest" class="font-black text-slate-800 text-xl tracking-tight">0 FCFA</div>
                    </div>
                    <div class="p-6 text-center group/stat transition-colors hover:bg-white">
                        <div class="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-2">Op√©rations</div>
                        <div id="stat-logs" class="font-black text-slate-800 text-xl tracking-tight">0</div>
                    </div>
                    <div class="p-6 text-center group/stat transition-colors hover:bg-white">
                        <div class="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-2">Prochaine √âch√©ance</div>
                        <div id="stat-next-service" class="font-black text-slate-800 text-xl tracking-tight">-</div>
                    </div>
                </div>
            </div>

            <!-- TIMELINE LUX -->
            <div id="view-dashboard" class="space-y-8 no-print pt-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6 px-2">
                    <h3 class="text-2xl font-black text-slate-800 tracking-tight flex items-center gap-3">
                        Journal de bord
                        <span class="text-sm font-bold bg-slate-200 text-slate-600 px-3 py-1 rounded-full" id="logs-count-badge">0</span>
                    </h3>
                    <div class="flex gap-2 bg-white p-1.5 rounded-2xl border border-slate-200 shadow-sm overflow-x-auto no-scrollbar w-full sm:w-auto">
                        <button onclick="setFilter('all', this)" class="filter-btn active px-6 py-2.5 rounded-xl text-xs font-black whitespace-nowrap transition-all bg-slate-900 text-white shadow-xl">Tous</button>
                        <button onclick="setFilter('maintenance', this)" class="filter-btn px-6 py-2.5 rounded-xl text-xs font-black whitespace-nowrap transition-all text-slate-500 hover:text-blue-600">Entretien</button>
                        <button onclick="setFilter('admin', this)" class="filter-btn px-6 py-2.5 rounded-xl text-xs font-black whitespace-nowrap transition-all text-slate-500 hover:text-purple-600">Papiers</button>
                    </div>
                </div>
                <div id="timeline-container" class="space-y-8 relative timeline-line pb-12"></div>
            </div>

            <!-- CERTIFICATE LUX (VENTE) -->
            <div id="view-buyer" class="hidden space-y-8 slide-up">
                <div class="bg-slate-900 text-white p-10 rounded-[3rem] shadow-[0_35px_60px_-15px_rgba(0,0,0,0.3)] text-center print:border print:border-slate-800 print:text-black print:bg-none relative overflow-hidden group">
                    <div class="absolute inset-0 bg-blue-600 opacity-0 group-hover:opacity-5 transition-opacity"></div>
                    <div class="relative z-10">
                        <div class="w-20 h-20 bg-green-400/20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="shield-check" class="w-10 h-10 text-green-400"></i>
                        </div>
                        <h2 class="text-3xl font-black mb-2 tracking-tight">Certificat de Transparence</h2>
                        <p class="text-slate-400 text-sm mb-10 leading-relaxed font-medium">Historique d'entretien v√©rifi√© par AutoCarnet LuxUI.</p>
                        <div class="grid grid-cols-2 gap-6 text-left max-w-2xl mx-auto">
                            <div class="bg-white/5 p-6 rounded-3xl border border-white/10 print:border-slate-300">
                                <div class="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-2">Propri√©taire</div>
                                <div id="cert-owner" class="font-black text-xl tracking-tight">--</div>
                            </div>
                            <div class="bg-white/5 p-6 rounded-3xl border border-white/10 print:border-slate-300">
                                <div class="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-2">V√©hicule</div>
                                <div id="cert-car" class="font-black text-xl tracking-tight">--</div>
                                <div id="cert-vin" class="text-[10px] font-mono text-slate-400 mt-2 uppercase opacity-60 tracking-wider font-bold">--</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-[2.5rem] shadow-xl border border-slate-100 overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50/50 border-b border-slate-100">
                            <tr>
                                <th class="px-8 py-5 font-black uppercase text-[10px] text-slate-400 tracking-widest">Date</th>
                                <th class="px-8 py-5 font-black uppercase text-[10px] text-slate-400 tracking-widest">Op√©ration</th>
                                <th class="px-8 py-5 font-black uppercase text-[10px] text-slate-400 tracking-widest text-right">Km</th>
                                <th class="px-8 py-5 font-black uppercase text-[10px] text-slate-400 tracking-widest text-center">Preuve</th>
                            </tr>
                        </thead>
                        <tbody id="cert-table-body" class="divide-y divide-slate-50 font-medium"></tbody>
                    </table>
                </div>
                <button onclick="window.print()" class="w-full py-6 bg-slate-900 text-white font-black rounded-[2rem] flex items-center justify-center gap-3 no-print active:scale-95 transition shadow-2xl shadow-slate-900/20 text-lg">
                    <i data-lucide="printer" class="w-6 h-6"></i> G√©n√©rer le dossier de vente
                </button>
            </div>
        </div>
    </main>

    <!-- NAV BOTTOM LUX -->
    <nav id="bottom-nav" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bg-slate-900/95 backdrop-blur-2xl border border-white/10 px-8 py-3 z-40 flex justify-between items-center rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.3)] no-print">
        <button onclick="switchView('view-dashboard')" id="nav-dashboard" class="nav-btn flex flex-col items-center gap-1.5 p-3 rounded-2xl text-blue-400 bg-white/5 transition-all duration-300">
            <i data-lucide="history" class="w-6 h-6"></i>
            <span class="text-[10px] font-black uppercase tracking-widest">Journal</span>
        </button>
        <button onclick="openLogModal()" class="flex flex-col items-center justify-center -mt-16 bg-blue-600 text-white w-20 h-20 rounded-[2rem] shadow-2xl shadow-blue-600/40 active:scale-90 transition-all duration-300 ring-8 ring-slate-50">
            <i data-lucide="plus" class="w-10 h-10"></i>
        </button>
        <button onclick="switchView('view-buyer')" id="nav-buyer" class="nav-btn flex flex-col items-center gap-1.5 p-3 rounded-2xl text-slate-500 transition-all duration-300 hover:text-white">
            <i data-lucide="share-2" class="w-6 h-6"></i>
            <span class="text-[10px] font-black uppercase tracking-widest">Vente</span>
        </button>
    </nav>

    <!-- MODAL LUX: LOG -->
    <div id="modal-log" class="modal-container fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="modal-backdrop absolute inset-0" onclick="toggleModal('modal-log', false)"></div>
        <div class="modal-content relative bg-white w-full max-w-lg rounded-t-[3rem] sm:rounded-[3rem] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col max-h-[90vh] border border-slate-100">
            <div class="flex justify-between items-center p-8 border-b border-slate-50">
                <h2 id="modal-log-title" class="text-2xl font-black text-slate-800 tracking-tight">Nouvelle Entr√©e</h2>
                <button onclick="toggleModal('modal-log', false)" class="p-3 bg-slate-100 rounded-2xl text-slate-500 active:scale-90 transition-transform"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="form-log" class="p-8 space-y-6 overflow-y-auto">
                <input type="hidden" id="log-id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Cat√©gorie</label>
                        <select id="log-type" onchange="toggleExpiryField()" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/10 font-bold transition-all"><option value="maintenance">üõ†Ô∏è Entretien</option><option value="repair">üîß R√©paration</option><option value="admin">üìÑ Papiers</option></select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Date</label>
                        <input type="date" id="log-date" required class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/10 font-bold transition-all">
                    </div>
                </div>
                <div id="expiry-field" class="hidden bg-purple-50 p-6 rounded-3xl border border-purple-100 space-y-2 animate-in slide-in-from-top-2">
                    <label class="text-[10px] font-black text-purple-700 uppercase tracking-widest">Date d'expiration</label>
                    <input type="date" id="log-expiry" class="w-full p-4 bg-white border border-purple-200 rounded-2xl outline-none font-bold">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">D√©signation</label>
                    <input type="text" id="log-title" required list="designation-suggestions" placeholder="Ex: Vidange 10W40 + Filtres" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/10 font-bold transition-all placeholder:text-slate-300">
                    
                    <!-- Liste de propositions exhaustive -->
                    <datalist id="designation-suggestions">
                        <!-- ENTRETIEN COURANT -->
                        <option value="Vidange Moteur + Filtre √† huile"></option>
                        <option value="Remplacement Filtre √† Air"></option>
                        <option value="Remplacement Filtre Habitacle"></option>
                        <option value="Remplacement Filtre √† Carburant"></option>
                        <option value="Recharge Climatisation"></option>
                        <option value="Remplacement Bougies d'allumage"></option>
                        <option value="Remplacement Balais d'essuie-glace"></option>
                        <option value="Mise √† niveau Liquide de Refroidissement"></option>
                        <option value="Remplacement Liquide de Frein"></option>
                        <!-- M√âCANIQUE ET R√âPARATIONS -->
                        <option value="Remplacement Plaquettes de Frein (AV)"></option>
                        <option value="Remplacement Plaquettes de Frein (AR)"></option>
                        <option value="Remplacement Disques + Plaquettes"></option>
                        <option value="Remplacement Kit de Distribution + Pompe √† eau"></option>
                        <option value="Remplacement Courroie d'Accessoire"></option>
                        <option value="Remplacement Batterie"></option>
                        <option value="Remplacement Pneus (Train Avant)"></option>
                        <option value="Remplacement Pneus (Train Arri√®re)"></option>
                        <option value="G√©om√©trie et Parall√©lisme"></option>
                        <option value="Remplacement Amortisseurs (AV)"></option>
                        <option value="Remplacement Amortisseurs (AR)"></option>
                        <option value="Remplacement Kit d'Embrayage"></option>
                        <option value="Remplacement Alternateur"></option>
                        <option value="Remplacement D√©marreur"></option>
                        <option value="Nettoyage Syst√®me Injection"></option>
                        <!-- CUSTOMISATION & ESTH√âTIQUE -->
                        <option value="Lavage Complet (Int√©rieur/Ext√©rieur)"></option>
                        <option value="Polissage et Lustrage Carrosserie"></option>
                        <option value="Traitement C√©ramique"></option>
                        <option value="Pose de Vitres Teint√©es"></option>
                        <option value="Installation Autoradio Android / Apple CarPlay"></option>
                        <option value="Installation Cam√©ra de Recul"></option>
                        <option value="Remplacement Jantes"></option>
                        <option value="Peinture √âtriers de Frein"></option>
                        <option value="Reprogrammation Moteur (Stage 1)"></option>
                        <option value="Conversion Ethanol (E85)"></option>
                        <option value="Installation √âclairage LED"></option>
                        <!-- PAPIERS ET ADMINISTRATIF -->
                        <option value="Visite Technique"></option>
                        <option value="Renouvellement Assurance"></option>
                        <option value="Paiement Vignette Annuelle"></option>
                        <option value="Changement de Carte Grise"></option>
                        <option value="Contr√¥le Antipollution"></option>
                        <option value="Duplicata Permis de Conduire"></option>
                    </datalist>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Km actuel</label>
                        <input type="number" id="log-mileage" required placeholder="0" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Montant (FCFA)</label>
                        <input type="number" id="log-cost" placeholder="0" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold">
                    </div>
                </div>
                <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 space-y-5">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="log-certified" onchange="toggleProDetails()" class="w-6 h-6 rounded-lg border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        <label for="log-certified" class="text-sm font-black text-slate-700 cursor-pointer select-none">R√©alis√© par un Garage Pro</label>
                    </div>
                    <div id="pro-details" class="hidden grid grid-cols-2 gap-3 animate-in fade-in">
                        <input id="log-provider" placeholder="Nom du Garage" class="p-3 border border-slate-200 rounded-xl text-sm bg-white font-bold outline-none">
                        <input id="log-provider-phone" placeholder="T√©l du Garage" class="p-3 border border-slate-200 rounded-xl text-sm bg-white font-bold outline-none">
                    </div>
                    <div class="relative border-2 border-slate-200 border-dashed rounded-2xl p-4 hover:bg-white transition-all cursor-pointer flex items-center gap-4 group">
                        <input type="file" id="log-file" onchange="handleFileChange()" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div id="file-icon" class="w-10 h-10 rounded-xl bg-white shadow-sm text-slate-400 flex items-center justify-center group-hover:bg-blue-50 group-hover:text-blue-500 transition-colors">
                            <i data-lucide="camera" class="w-5 h-5"></i>
                        </div>
                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest truncate group-hover:text-blue-600 transition-colors" id="file-name">Attacher une facture</div>
                    </div>
                </div>
                <button type="submit" class="w-full py-5 bg-slate-900 text-white font-black rounded-2xl active:scale-[0.98] transition-all text-xl shadow-2xl shadow-slate-900/20">Valider l'entr√©e</button>
            </form>
        </div>
    </div>

    <!-- MODAL LUX: VEHICLE -->
    <div id="modal-profile" class="modal-container fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="modal-backdrop absolute inset-0" onclick="toggleModal('modal-profile', false)"></div>
        <div class="modal-content relative bg-white w-full max-w-md rounded-t-[3rem] sm:rounded-[3rem] shadow-2xl p-8 border border-slate-100">
            <h2 id="modal-profile-title" class="text-3xl font-black mb-8 tracking-tight">Configuration</h2>
            <form id="form-profile" class="space-y-6">
                <input type="hidden" id="prof-id">
                <div class="bg-blue-50 p-6 rounded-3xl border border-blue-100 space-y-4 shadow-inner">
                    <div class="flex items-center gap-2 text-[10px] font-black text-blue-600 uppercase tracking-widest"><i data-lucide="user"></i> Propri√©taire</div>
                    <input id="prof-owner" required placeholder="Nom & Pr√©nom" class="p-4 rounded-2xl w-full text-sm bg-white border border-blue-200 outline-none font-bold focus:ring-4 focus:ring-blue-500/10 transition-all">
                    <input id="prof-contact" placeholder="T√©l (Optionnel)" class="p-4 rounded-2xl w-full text-sm bg-white border border-blue-200 outline-none font-bold focus:ring-4 focus:ring-blue-500/10 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Marque</label><input id="prof-make" required class="p-4 border border-slate-100 bg-slate-50 rounded-2xl w-full outline-none font-bold"></div>
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Mod√®le</label><input id="prof-model" required class="p-4 border border-slate-100 bg-slate-50 rounded-2xl w-full outline-none font-bold"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Ann√©e</label><input id="prof-year" type="number" required class="p-4 border border-slate-100 bg-slate-50 rounded-2xl w-full outline-none font-bold"></div>
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Km Initial</label><input id="prof-mileage" type="number" required class="p-4 border border-slate-100 bg-slate-50 rounded-2xl w-full outline-none font-bold"></div>
                </div>
                <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Immatriculation</label><input id="prof-plate" required placeholder="ex: AA-123-BB" class="p-4 border border-slate-100 bg-slate-50 rounded-2xl w-full uppercase outline-none font-black text-xl text-center tracking-widest"></div>
                <button type="submit" class="w-full py-6 bg-slate-900 text-white rounded-[2rem] font-black active:scale-[0.98] transition-all mt-4 shadow-2xl shadow-slate-900/20 text-lg">Sauvegarder</button>
            </form>
        </div>
    </div>

    <script>
        // --- LOGIQUE LUXUI ---
        let vehicles = JSON.parse(localStorage.getItem('autocarnet_v4_vehicles')) || [];
        let logsByCar = JSON.parse(localStorage.getItem('autocarnet_v4_logs')) || {};
        let currentVehicleId = localStorage.getItem('autocarnet_v4_currentId') || null;
        let activeFilter = 'all';

        // Helper s√©curis√© pour r√©cup√©rer les √©l√©ments par ID
        const el = (id) => {
            const element = document.getElementById(id);
            if (!element) console.warn(`√âl√©ment avec l'ID "${id}" introuvable.`);
            return element;
        };

        function init() {
            if (vehicles.length === 0) {
                const onboarding = el('onboarding-state');
                const appContent = el('app-content');
                if (onboarding) onboarding.classList.remove('hidden');
                if (appContent) appContent.classList.add('hidden');
            } else {
                if (!currentVehicleId || !vehicles.find(v => v.id === currentVehicleId)) {
                    currentVehicleId = vehicles[0].id;
                }
                const onboarding = el('onboarding-state');
                const appContent = el('app-content');
                const bottomNav = el('bottom-nav');
                const selector = el('vehicle-selector-container');
                
                if (onboarding) onboarding.classList.add('hidden');
                if (appContent) appContent.classList.remove('hidden');
                if (bottomNav) bottomNav.classList.remove('hidden');
                if (selector) selector.classList.remove('hidden');
                
                renderHeader();
                renderAll();
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderHeader() {
            const select = el('vehicle-select');
            if (!select) return;
            select.innerHTML = '';
            vehicles.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.text = `${v.make} ${v.model}`;
                opt.selected = v.id === currentVehicleId;
                select.appendChild(opt);
            });
            select.onchange = (e) => {
                currentVehicleId = e.target.value;
                localStorage.setItem('autocarnet_v4_currentId', currentVehicleId);
                renderAll();
            };
        }

        function renderAll() {
            const car = vehicles.find(v => v.id === currentVehicleId);
            if (!car) return;

            const title = el('car-title');
            const year = el('car-year');
            const mileage = el('car-mileage');
            const plate = el('car-plate');
            const owner = el('car-owner');
            const certOwner = el('cert-owner');
            const certCar = el('cert-car');
            const certVin = el('cert-vin');

            if (title) title.textContent = car.make;
            if (year) year.textContent = car.year;
            if (mileage) mileage.textContent = parseInt(car.mileage).toLocaleString();
            if (plate) plate.textContent = car.plate;
            if (owner) owner.textContent = car.owner;
            if (certOwner) certOwner.textContent = car.owner;
            if (certCar) certCar.textContent = `${car.make} ${car.model}`;
            if (certVin) certVin.textContent = car.vin || car.plate;

            const carLogs = logsByCar[currentVehicleId] || [];
            carLogs.sort((a, b) => new Date(b.date) - new Date(a.date));

            const container = el('timeline-container');
            const tbody = el('cert-table-body');
            if (!container || !tbody) return;
            
            container.innerHTML = '';
            tbody.innerHTML = '';

            const filtered = activeFilter === 'all' ? carLogs : carLogs.filter(l => l.type === activeFilter);
            const badge = el('logs-count-badge');
            if (badge) badge.textContent = filtered.length;

            filtered.forEach((log, idx) => {
                const card = document.createElement('div');
                card.className = "relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group slide-up";
                card.style.animationDelay = `${idx * 0.05}s`;
                
                const isCertified = log.isCertified && log.provider && log.providerPhone;
                const iconMap = { maintenance: 'settings', repair: 'wrench', admin: 'shield' };
                const currentIcon = iconMap[log.type] || 'circle-dot';
                
                card.innerHTML = `
                    <div class="flex items-center justify-center w-12 h-12 rounded-2xl border-4 border-slate-50 bg-white shadow-lg shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10 absolute left-0 md:static transition-transform duration-300 group-hover:scale-110">
                        <i data-lucide="${currentIcon}" class="w-5 h-5 ${log.type === 'maintenance' ? 'text-blue-500' : log.type === 'admin' ? 'text-purple-500' : 'text-orange-500'}"></i>
                    </div>
                    <div class="w-[calc(100%-4rem)] md:w-[calc(50%-3.5rem)] ml-16 md:ml-0 bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 hover:shadow-2xl transition-all duration-500 relative group-hover:-translate-y-2 group-hover:border-blue-100">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] uppercase font-black tracking-widest px-3 py-1 rounded-full ${log.type === 'maintenance' ? 'bg-blue-50 text-blue-600' : log.type === 'admin' ? 'bg-purple-50 text-purple-600' : 'bg-orange-50 text-orange-600'}">${log.type}</span>
                            <span class="text-xs font-black text-slate-300 uppercase tracking-widest">${new Date(log.date).toLocaleDateString()}</span>
                        </div>
                        <h4 class="font-black text-slate-800 text-lg flex items-center gap-2 mb-3 tracking-tight">
                            ${log.title} ${isCertified ? '<span class="text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5 fill-green-50"></i></span>' : ''}
                        </h4>
                        <div class="flex flex-wrap gap-4 text-xs font-bold text-slate-500 mb-5">
                            <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-xl"><i data-lucide="gauge" class="w-3.5 h-3.5"></i> ${parseInt(log.mileage).toLocaleString()} km</div>
                            ${log.provider ? `<div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-xl"><i data-lucide="store" class="w-3.5 h-3.5"></i> ${log.provider}</div>` : ''}
                            ${log.proofFileName ? `<div class="text-blue-600 flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-xl"><i data-lucide="paperclip" class="w-3.5 h-3.5"></i> ${log.proofFileName}</div>` : ''}
                        </div>
                        <div class="flex justify-between items-center pt-4 border-t border-slate-50">
                            <div class="font-black text-slate-900 text-lg">${log.cost > 0 ? new Intl.NumberFormat().format(log.cost) + ' FCFA' : 'GRATUIT'}</div>
                            <div class="flex gap-2">
                                <button onclick="editLog('${log.id}')" class="p-2 hover:bg-blue-50 rounded-xl text-blue-500 transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="deleteLog('${log.id}')" class="p-2 hover:bg-red-50 rounded-xl text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-8 py-5 text-slate-400 font-bold whitespace-nowrap">${new Date(log.date).toLocaleDateString()}</td>
                    <td class="px-8 py-5 font-black text-slate-800 text-base">${log.title} <div class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest">${log.provider || ''}</div></td>
                    <td class="px-8 py-5 text-right font-black text-slate-600 text-lg">${parseInt(log.mileage).toLocaleString()}</td>
                    <td class="px-8 py-5 text-center">${log.hasProof ? '<span class="text-green-500"><i data-lucide="check" class="w-5 h-5 mx-auto"></i></span>' : '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            const statInvest = el('stat-invest');
            const statLogs = el('stat-logs');
            const totalCost = carLogs.reduce((acc, l) => acc + (parseInt(l.cost) || 0), 0);
            if (statInvest) statInvest.textContent = new Intl.NumberFormat().format(totalCost) + ' F';
            if (statLogs) statLogs.textContent = carLogs.length;

            // Next Service Logic LuxUI
            const oilChanges = carLogs.filter(l => l.title.toLowerCase().includes('vidange'));
            const statNext = el('stat-next-service');
            if(statNext) {
                if(oilChanges.length > 0) {
                    const lastMileage = parseInt(oilChanges[0].mileage);
                    const nextMileage = lastMileage + 10000;
                    statNext.textContent = nextMileage.toLocaleString() + ' km';
                    statNext.className = (nextMileage < parseInt(car.mileage)) ? "font-black text-red-500 text-xl" : "font-black text-slate-800 text-xl";
                } else { statNext.textContent = '-'; }
            }

            // Score Confiance LuxUI
            let score = 20; 
            if (car.vin) score += 20;
            score += Math.min(carLogs.length * 5, 30);
            score += Math.min(carLogs.filter(l => l.hasProof).length * 10, 30);
            
            const scoreText = el('trust-score-text');
            const scoreCircle = el('trust-score-circle');
            const scoreIcon = el('trust-score-icon');
            
            if (scoreText) scoreText.textContent = score + "%";
            if (scoreCircle) scoreCircle.style.strokeDashoffset = 176 - (176 * score) / 100;
            
            if (scoreCircle && scoreIcon) {
                if (score > 70) { scoreCircle.style.color = "#22c55e"; scoreIcon.style.color = "#22c55e"; }
                else if (score > 40) { scoreCircle.style.color = "#f59e0b"; scoreIcon.style.color = "#f59e0b"; }
                else { scoreCircle.style.color = "#ef4444"; scoreIcon.style.color = "#ef4444"; }
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
            checkAlerts(carLogs);
        }

        function saveToLocal() {
            localStorage.setItem('autocarnet_v4_vehicles', JSON.stringify(vehicles));
            localStorage.setItem('autocarnet_v4_logs', JSON.stringify(logsByCar));
            renderAll();
        }

        function toggleModal(id, show) { 
            const m = el(id);
            if (m) m.classList.toggle('active', show); 
        }

        function switchView(viewId) {
            const dashboard = el('view-dashboard');
            const buyer = el('view-buyer');
            if (dashboard) dashboard.classList.toggle('hidden', viewId !== 'view-dashboard');
            if (buyer) buyer.classList.toggle('hidden', viewId !== 'view-buyer');
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('text-blue-400', 'bg-white/5');
                b.classList.add('text-slate-500');
            });
            const activeNav = el(viewId === 'view-dashboard' ? 'nav-dashboard' : 'nav-buyer');
            if (activeNav) {
                activeNav.classList.add('text-blue-400', 'bg-white/5');
                activeNav.classList.remove('text-slate-500');
            }
        }

        function setFilter(filter, btn) {
            activeFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('active', 'bg-slate-900', 'text-white', 'shadow-xl');
                b.classList.add('text-slate-500');
            });
            if (btn) {
                btn.classList.add('active', 'bg-slate-900', 'text-white', 'shadow-xl');
                btn.classList.remove('text-slate-500');
            }
            renderAll();
        }

        // --- GESTIONNAIRE FORMULAIRE INTERVENTION ---
        const formLog = el('form-log');
        if (formLog) {
            formLog.onsubmit = (e) => {
                e.preventDefault();
                
                const carLogs = logsByCar[currentVehicleId] || [];
                const logIdInput = el('log-id');
                const logIdVal = logIdInput ? logIdInput.value : '';
                const id = logIdVal || Date.now().toString();
                
                // On cherche l'entr√©e existante si on modifie
                const existingLog = logIdVal ? carLogs.find(l => l.id === logIdVal) : null;
                
                const fileInput = el('log-file');
                const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
                const newFileName = hasFile ? fileInput.files[0].name : null;

                const newLog = {
                    id,
                    type: el('log-type')?.value || 'maintenance',
                    date: el('log-date')?.value || new Date().toISOString().split('T')[0],
                    title: el('log-title')?.value || '',
                    mileage: parseInt(el('log-mileage')?.value) || 0,
                    cost: parseFloat(el('log-cost')?.value) || 0,
                    isCertified: el('log-certified')?.checked || false,
                    provider: el('log-provider')?.value || '',
                    providerPhone: el('log-provider-phone')?.value || '',
                    expiryDate: el('log-expiry')?.value || null,
                    hasProof: hasFile || (existingLog ? existingLog.hasProof : false),
                    proofFileName: newFileName || (existingLog ? existingLog.proofFileName : null)
                };

                if (!logsByCar[currentVehicleId]) logsByCar[currentVehicleId] = [];
                const idx = logsByCar[currentVehicleId].findIndex(l => l.id === id);
                if (idx > -1) logsByCar[currentVehicleId][idx] = newLog;
                else logsByCar[currentVehicleId].push(newLog);

                const car = vehicles.find(v => v.id === currentVehicleId);
                if (car && parseInt(newLog.mileage) > parseInt(car.mileage)) car.mileage = newLog.mileage.toString();

                toggleModal('modal-log', false);
                saveToLocal();
            };
        }

        window.editLog = (id) => {
            const log = (logsByCar[currentVehicleId] || []).find(l => l.id === id);
            if (!log) return;
            
            const logId = el('log-id'); if (logId) logId.value = log.id;
            const logType = el('log-type'); if (logType) logType.value = log.type;
            const logDate = el('log-date'); if (logDate) logDate.value = log.date;
            const logTitle = el('log-title'); 
            if (logTitle) logTitle.value = log.title;
            
            const logMileage = el('log-mileage'); if (logMileage) logMileage.value = log.mileage;
            const logCost = el('log-cost'); if (logCost) logCost.value = log.cost;
            const logCertified = el('log-certified'); if (logCertified) logCertified.checked = log.isCertified;
            const logProvider = el('log-provider'); if (logProvider) logProvider.value = log.provider || '';
            const logPhone = el('log-provider-phone'); if (logPhone) logPhone.value = log.providerPhone || '';
            const logExpiry = el('log-expiry'); if (logExpiry) logExpiry.value = log.expiryDate || '';
            
            toggleExpiryField(); 
            toggleProDetails();
            
            const fileName = el('file-name');
            if (fileName) fileName.textContent = log.proofFileName || "Attacher une facture";
            
            toggleModal('modal-log', true);
            const modalTitle = el('modal-log-title');
            if (modalTitle) modalTitle.textContent = "Modifier l'entr√©e";
        };

        window.deleteLog = (id) => { 
            if(confirm("Supprimer cette op√©ration d√©finitivement ?")) { 
                logsByCar[currentVehicleId] = (logsByCar[currentVehicleId] || []).filter(l => l.id !== id); 
                saveToLocal(); 
            } 
        };

        const formProfile = el('form-profile');
        if (formProfile) {
            formProfile.onsubmit = (e) => {
                e.preventDefault();
                const profId = el('prof-id');
                const id = (profId && profId.value) ? profId.value : Date.now().toString();
                const newCar = {
                    id, 
                    owner: el('prof-owner')?.value || '', 
                    ownerContact: el('prof-contact')?.value || '',
                    make: el('prof-make')?.value || '', 
                    model: el('prof-model')?.value || '', 
                    year: el('prof-year')?.value || '',
                    mileage: el('prof-mileage')?.value || '0', 
                    plate: el('prof-plate')?.value || '', 
                    vin: el('prof-vin')?.value || ''
                };
                const idx = vehicles.findIndex(v => v.id === id);
                if (idx > -1) vehicles[idx] = newCar;
                else { 
                    vehicles.push(newCar); 
                    currentVehicleId = id; 
                    localStorage.setItem('autocarnet_v4_currentId', id); 
                }
                toggleModal('modal-profile', false);
                init();
                saveToLocal();
            };
        }

        window.openProfileModal = (car = null) => {
            const form = el('form-profile');
            if (form) form.reset();
            const modalTitle = el('modal-profile-title');
            
            if (car) {
                if (el('prof-id')) el('prof-id').value = car.id; 
                if (el('prof-owner')) el('prof-owner').value = car.owner;
                if (el('prof-contact')) el('prof-contact').value = car.ownerContact; 
                if (el('prof-make')) el('prof-make').value = car.make;
                if (el('prof-model')) el('prof-model').value = car.model; 
                if (el('prof-year')) el('prof-year').value = car.year;
                if (el('prof-mileage')) el('prof-mileage').value = car.mileage; 
                if (el('prof-plate')) el('prof-plate').value = car.plate;
                if (el('prof-vin')) el('prof-vin').value = car.vin || '';
                if (modalTitle) modalTitle.textContent = "Modifier V√©hicule";
            } else { 
                if (modalTitle) modalTitle.textContent = "Configuration"; 
            }
            toggleModal('modal-profile', true);
        };

        window.openLogModal = () => {
            const form = el('form-log');
            if (form) form.reset();
            const idInput = el('log-id'); if (idInput) idInput.value = '';
            const dateInput = el('log-date'); if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
            const fileName = el('file-name'); if (fileName) fileName.textContent = "Attacher une facture";
            
            toggleExpiryField(); 
            toggleProDetails();
            toggleModal('modal-log', true); 
            const modalTitle = el('modal-log-title');
            if (modalTitle) modalTitle.textContent = "Nouvelle Entr√©e";
        };

        window.toggleExpiryField = () => {
            const type = el('log-type');
            const field = el('expiry-field');
            if (field && type) field.classList.toggle('hidden', type.value !== 'admin');
        };
        
        window.toggleProDetails = () => {
            const cert = el('log-certified');
            const details = el('pro-details');
            if (details && cert) details.classList.toggle('hidden', !cert.checked);
        };
        
        window.handleFileChange = () => {
            const input = el('log-file');
            const name = (input && input.files && input.files[0]) ? input.files[0].name : "Attacher une facture";
            const fileName = el('file-name'); if (fileName) fileName.textContent = name;
            const icon = el('file-icon');
            if (icon) icon.className = "w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center shadow-lg shadow-blue-500/30";
        };

        function checkAlerts(carLogs) {
            const container = el('alerts-container'); 
            if (!container) return;
            container.innerHTML = '';
            const now = new Date();
            carLogs.forEach(log => {
                if (log.expiryDate) {
                    const days = (new Date(log.expiryDate) - now) / 86400000;
                    if (days < 30) {
                        const div = document.createElement('div');
                        const isPast = days < 0;
                        div.className = `p-5 rounded-3xl flex items-center gap-4 text-sm font-black border slide-up ${isPast ? 'bg-red-50 text-red-900 border-red-100' : 'bg-orange-50 text-orange-900 border-orange-100 shadow-xl shadow-orange-500/10'}`;
                        div.innerHTML = `<div class="bg-white p-2.5 rounded-2xl shadow-sm"><i data-lucide="alert-circle" class="w-6 h-6"></i></div> <div><div class="uppercase tracking-widest text-[10px] opacity-60 mb-1">Alerte √âch√©ance</div><span>${log.title} ${isPast ? 'est expir√© !' : 'expire prochainement'}</span></div>`;
                        container.appendChild(div);
                    }
                }
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Initialisation apr√®s chargement
        window.onload = init;
    </script>
</body>
</html>
